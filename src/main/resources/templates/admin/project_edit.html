<!-- 【企画編集・情報】 -->
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${project.name} + ' | 企画編集・情報'">データが取得できませんでした:企画名 | 企画編集・情報</title>
    <link rel="icon" th:href="@{/img/zoutohana-jitsubutsu.png}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="../../static/css/admin/admin-style.css" th:href="@{/css/admin/admin-style.css}">
</head>
<body id="projectEdit-page">
    <div th:replace="~{layout-admin :: header}"></div>

    <main id="admin-main">
      <a href="project_list.html" th:href="@{/admin/project/list}" th:object="${project}" class="icon-center review-card-sub-info text-decoration-none hover-bold">
        <span class="material-symbols-outlined">keyboard_double_arrow_left</span>企画一覧に戻る
      </a>
      <h1 class="page-title">
        <span class="material-symbols-outlined scale-bigger text-gray mr-2">docs</span>
        企画編集・情報
      </h1>

      <div class="tab-menu w-full mt-2">
        <ul class="tab-list">
          <li class="tab-item active" tabindex="0">企画について</li>
          <li class="tab-item" tabindex="0">投稿された書評について</li>
        </ul>
      </div>

      <div class="tab-content">
        <div class="main-content-card tab-panel active"> <!-- 「企画について」タブの中身 -->
          <form method="post" th:action="@{/admin/project/view/{urlKey}(urlKey=${project.urlKey})}" th:object="${project}" class="no-auto-submit">
<!--            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
            <div class="table-container">
              <table>
                <tr>
                  <th>公開/非公開 : </th>
                  <td>
                    <div class="radio-wrap ml-2">
                      <label>
                        <input type="radio" name="published" value="TRUE" class="scale-bigger" th:checked="${project.published == true}">
                        公開
                      </label>
                      <label>
                        <input type="radio" name="published" value="FALSE" class="scale-bigger" th:checked="${project.published == false}">
                        非公開
                      </label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th>ステータス : </th>
                  <td>
                    <select name="status" class="select w-half">
                      <option value="BEFORE_SUBMISSION" th:selected="${project.status.name() == 'BEFORE_SUBMISSION'}">書評投稿期間前</option>
                      <option value="DURING_SUBMISSION" th:selected="${project.status.name() == 'DURING_SUBMISSION'}">書評投稿期間</option>
                      <option value="FIRST_PHASE" th:selected="${project.status.name() == 'FIRST_PHASE'}">一次審査</option>
                      <option value="SECOND_PHASE_VOTING" th:selected="${project.status.name() == 'SECOND_PHASE_VOTING'}">二次審査(投票)</option>
                      <option value="SECOND_PHASE_VERIFY" th:selected="${project.status.name() == 'SECOND_PHASE_VERIFY'}">二次審査(確認)</option>
                      <option value="SECOND_PHASE_RESULT" th:selected="${project.status.name() == 'SECOND_PHASE_RESULT'}">ノミネート発表</option>
                      <option value="AWARD_ANNOUNCEMENT" th:selected="${project.status.name() == 'AWARD_ANNOUNCEMENT'}">大賞発表</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th class="table-border-b-strong">削除 : </th>
                  <td class="table-border-b-strong">
                    <button type="button" class="btn btn-danger" data-modal-target="delete-confirm-modal">この企画を削除する</button>
                  </td>
                </tr>

                <tr>
                  <th>企画名 : </th>
                  <td>
                    <input type="text" name="name" class="input-text w-full" th:value="${project.name}">
                    <p class="text-danger"></p>
                  </td>
                </tr>
                <tr>
                  <th>
                    <span class="icon-center gap-1">
                      企画URL<span class="material-symbols-outlined text-gray cursor-help" title="企画ページのURLの末尾につく文字列です。">help</span> : </th>
                    </span>
                  <td>
                    <input type="text" name="urlKey" id="urlKey-input" class="input-text w-full" th:value="${project.urlKey}">
                    <span class="text-gray">https://zoutohana-fansite.com/project/</span><span id="urlKey-preview" class="text-gray" th:text="${project.urlKey}">_____</span>
                    <button type="button" class="btn-sm urlKey-copyBtn-fromInput">
                      <span class="material-symbols-outlined font-sm">content_copy</span>
                    </button>
                    <p th:if="${param.error}" style="color: red">すでに使用されている企画URLは利用できません</p>
                  </td>
                </tr>
                <tr>
                  <th>
                    <span class="icon-center gap-1">
                      書評投稿用URL :
                    </span>
                  </th>
                  <td>
                    <span th:text="${'https://zoutohana-fansite.com/login?id=' + project.id}"></span>
                    <button type="button" class="btn-sm urlKey-copyBtn-fromInput">
                      <span class="material-symbols-outlined font-sm">content_copy</span>
                    </button>
                  </td>
                </tr>
                <tr>
                  <th class="table-border-b-light">説明 : </th>
                  <td class="table-border-b-light"><textarea rows="10" name="introduction" class="input-textarea w-full" th:text="${project.introduction}"></textarea></td>
                </tr>

                <tr>
                  <th>企画期間 : </th>
                  <td>
                    <input type="datetime-local" name="projectStartAt" class="input-datetime" step="60" th:value="${#temporals.format(project.projectStartAt, 'yyyy-MM-dd''T''HH:mm')}">
                    <span class="wave-dash">～</span>
                    <input type="datetime-local" name="projectEndAt" class="input-datetime" step="60" th:value="${#temporals.format(project.projectEndAt, 'yyyy-MM-dd''T''HH:mm')}">
                  </td>
                </tr>
                <tr>
                  <th>書評作成・投稿期間 : </th>
                  <td>
                    <input type="datetime-local" name="submissionStartAt" class="input-datetime" step="60" th:value="${#temporals.format(project.submissionStartAt, 'yyyy-MM-dd''T''HH:mm')}">
                    <span class="wave-dash">～</span>
                    <input type="datetime-local" name="submissionEndAt" class="input-datetime" step="60" th:value="${#temporals.format(project.submissionEndAt, 'yyyy-MM-dd''T''HH:mm')}">
                  </td>
                </tr>
                <tr>
                  <th class="table-border-b-light">書評投票(二次審査)期間 : </th>
                  <td class="table-border-b-light">
                    <input type="datetime-local" name="votingStartAt" class="input-datetime" step="60" th:value="${#temporals.format(project.votingStartAt, 'yyyy-MM-dd''T''HH:mm')}">
                    <span class="wave-dash">～</span>
                    <input type="datetime-local" name="votingEndAt" class="input-datetime" step="60" th:value="${#temporals.format(project.votingEndAt, 'yyyy-MM-dd''T''HH:mm')}">
                  </td>
                </tr>
                <tr>
                  <th>テーマカラー : </th>
                  <td>
                    <div class="themeColor-wrap">
                      <label>
                        <input type="radio" name="themeColor" value="GREEN" th:checked="${project.themeColor.name() == 'GREEN'}">
                        <span class="color-dot" style="background:var(--theme-green);" title="GREEN : みどり">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>

                      <label>
                        <input type="radio" name="themeColor" value="PINK" th:checked="${project.themeColor.name() == 'PINK'}">
                        <span class="color-dot" style="background:var(--theme-pink);" title="PINK : もも">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>

                      <label>
                        <input type="radio" name="themeColor" value="YELLOW" th:checked="${project.themeColor.name() == 'YELLOW'}">
                        <span class="color-dot" style="background:var(--theme-yellow);" title="YELLOW : き">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>

                      <label>
                        <input type="radio" name="themeColor" value="BLUE" th:checked="${project.themeColor.name() == 'BLUE'}">
                        <span class="color-dot" style="background:var(--theme-blue);" title="BLUE : あお">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>

                      <label>
                        <input type="radio" name="themeColor" value="BLACK" th:checked="${project.themeColor.name() == 'BLACK'}">
                        <span class="color-dot" style="background:var(--theme-black);" title="BLACK : くろ">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>

                      <label>
                        <input type="radio" name="themeColor" value="GRAY" th:checked="${project.themeColor.name() == 'GRAY'}">
                        <span class="color-dot" style="background:var(--theme-gray);" title="GRAY : はい">
                          <span class="material-symbols-outlined">check</span>
                        </span>
                      </label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th>ロゴ画像 : </th>
                  <td id="projectInput-td">
                    <div>
                      <img id="mainImg-preview" th:src="@{/api/image/{fileName}(fileName=${fileName})}">
                    </div>
                  </td>
                </tr>
              </table>

              <div class="button-wrap mt-4">
                <a href="project_list.html" th:href="@{/admin/project/list}" class="btn">キャンセル</a>
                <input type="submit" value="更新する" class="btn">
              </div>
            </div>
            </form>
          </div>
        </div>

        <div class="main-content-card p-8 tab-panel"> <!-- 「投稿された書評について」タブの中身 -->
          <div class="table-border-b-strong pb-8"> <h2 class="page-title-sub">
            <span class="material-symbols-outlined scale-bigger text-gray mr-2">mail</span>
            通知一括送信
          </h2>

            <div class="flex gap-4 mt-2 mb-2">
              <label class="cursor-pointer">
                <input type="radio" name="targetPhase" value="FIRST_PHASE" class="scale-bigger" checked> 一次審査通過書評
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="targetPhase" value="SECOND_PHASE" class="scale-bigger"> 二次審査通過書評
              </label>
            </div>

            <div class="flex gap-1 mt-2">
              <span>テンプレート名 : </span>
              <select id="template-select" class="select flex-1 w-full">
                <option value="">選択してください</option>
              </select>
              <button type="button" id="load-template-button" class="btn">呼び出す</button>
            </div>
            <div class="flex gap-1 mt-2">
              <span style="flex-shrink: 0;">タイトル : </span>
              <input type="text" id="template-title" class="input-text flex-1" placeholder="通知のタイトルを入力してください">
            </div>
            <textarea id="template-textarea" rows="7" class="input-textarea w-full mt-2"></textarea>
            <p class="icon-center">置き換えタグ<span class="material-symbols-outlined text-gray cursor-help" title="個別通知送信時、自動的に各プロジェクト・書評・ユーザの情報に置換されます">help</span></p>
            <div class="grid-4 gap-1 mt-2">
              <button type="button" class="btn merge-tag" data-tag="{project-name}">プロジェクト名</button>
              <button type="button" class="btn merge-tag" data-tag="{project-submissionStartAt}">書評投稿開始日時</button>
              <button type="button" class="btn merge-tag" data-tag="{project-submissionEndAt}">書評投稿終了日時</button>
              <button type="button" class="btn merge-tag" data-tag="{project-votingStartAt}">書評投票開始日時</button>
              <button type="button" class="btn merge-tag" data-tag="{project-votingEndAt}">書評投票終了日時</button>
              <button type="button" class="btn merge-tag" data-tag="{user-nickname}">ユーザーのニックネーム</button>
              <button type="button" class="btn merge-tag" data-tag="{review-title}">書評タイトル</button>
              <button type="button" class="btn merge-tag" data-tag="{book-title}">書籍タイトル</button>
            </div>
            <div class="button-wrap mt-2 text-right">
              <button type="button" id="open-notification-confirm" class="btn">内容を確認する</button>
            </div>
          </div>

          <div class="pt-4 pb-4"> <!-- 「書評閲覧」部分 -->
            <h2 class="page-title-sub">
              <span class="material-symbols-outlined scale-bigger text-gray mr-2">note_stack</span>
              書評閲覧
            </h2>
            <div class="flex gap-1 mt-2">
              <a href="review_list.html" th:href="@{/admin/review/list(urlKey=${project.urlKey})}" class="btn icon-center">
                <span class="material-symbols-outlined scale-bigger pr-1">note_stack</span>すべての書評を確認
              </a>
              <a th:href="@{/admin/review/export(urlKey=${project.urlKey})}" class="btn icon-center">
                <span class="material-symbols-outlined scale-bigger pr-1">csv</span>
                <span class="material-symbols-outlined scale-bigger pr-1">download_2</span>
                すべての書評をCSV形式で出力
              </a>
            </div>
          </div>

          <div class="pt-4 pb-4"> <!-- 「大賞の書評」部分 -->
            <h2 class="page-title-sub">
              <span class="material-symbols-outlined scale-bigger text-gray mr-2">trophy</span>
              大賞の書評
            </h2>
            <div th:if="${!#lists.isEmpty(awardedReviews)}" class="review-card mt-4" th:each="awardedReview : ${awardedReviews}"> <!-- 書評カード -->
              <div class="table-border-b-strong flex justify-between py-4"> <!-- 書評カードヘッダー -->
                <div> <!-- 左側 -->
                  <p class="review-card-sub-info">No.<span th:text="${awardedReview.reviewId}">0</span></p>
                  <h3 class="review-card-title" th:text="${awardedReview.reviewTitle}">データが取得できませんでした:書評名</h3>
                  <p class="review-card-sub-info ml-4">
                    <a href="account_view.html" th:href="@{/admin/account/view(loginId=${awardedReview.userLoginId})}">
                      <span th:text="|${awardedReview.userNickname}(ID:${awardedReview.userLoginId})|">-----</span>
                    </a>
                  </p>
                </div>
                <h3 class="review-card-title" th:text="|${awardedReview.reviewVoteCount}票|">0票</h3> <!-- 右側 -->
              </div>
              <div class="table-border-b-strong flex py-4"> <!-- 書評カードボディ -->
                <table class="pr-8 mb-auto">
                  <tr>
                    <th>ISBN : </th>
                    <td th:text="${awardedReview.bookIsbn}">-----</td>
                  </tr>
                  <tr>
                    <th>タイトル : </th>
                    <td th:text="${awardedReview.bookTitle}">-----</td>
                  </tr>
                  <tr>
                    <th>出版社 : </th>
                    <td th:text="${awardedReview.bookPublisher}">-----</td>
                  </tr>
                  <tr>
                    <th>著者 : </th>
                    <td th:text="${awardedReview.bookAuthor}">-----</td>
                  </tr>
                </table>
                <div class="flex-1">
                  <p>本文 : </p>
                  <pre th:text="${awardedReview.reviewContent}"></pre>
                </div>
              </div>
              <div class="flex justify-between py-4"> <!-- 書評カードフッター -->
                <div> <!-- 左側 -->
                  <p class="review-card-sub-info" th:text="'投稿日時 : ' + ${#temporals.format(awardedReview.createdAt, 'yyyy/MM/dd HH:mm')}">0000/00/00 00:00</p>
                  <p class="review-card-sub-info" th:text="'更新日時 : ' + ${#temporals.format(awardedReview.updatedAt, 'yyyy/MM/dd HH:mm')}">0000/00/00 00:00</p>
                </div>
                <a href="review_edit.html" th:href="@{/admin/review/view(id=${awardedReview.reviewId})}" class="icon-center review-card-sub-info text-decoration-none hover-bold">詳細を確認する<span class="material-symbols-outlined ml-2">keyboard_double_arrow_right</span></a> <!-- 右側 -->
              </div>
            </div>
            <div th:if="${#lists.isEmpty(awardedReviews)}" class="review-card p-8 mt-4">
              <p class="text-center p-8">大賞の書評はありません</p>
            </div>
          </div>

          <div class="pt-4"> <!-- 「ノミネートした書評」部分 -->
            <h2 class="page-title-sub">
              <span class="material-symbols-outlined scale-bigger text-gray mr-2">star</span>
              ノミネートした書評
            </h2>
            <div th:if="${!#lists.isEmpty(nominatedReviews)}"> <!-- 書評カードを並べる部分 -->
              <div class="review-card mt-4" th:each="nominatedReview : ${nominatedReviews}"> <!-- 書評カード -->
                <div class="table-border-b-strong flex justify-between py-4"> <!-- 書評カードヘッダー -->
                  <div> <!-- 左側 -->
                    <p class="review-card-sub-info">No.<span th:text="${nominatedReview.reviewId}">0</span></p>
                    <h3 class="review-card-title" th:text="${nominatedReview.reviewTitle}">データが取得できませんでした:書評名</h3>
                    <p class="review-card-sub-info ml-4">
                      <a href="account_view.html" th:href="@{/admin/account/view(loginId=${nominatedReview.userLoginId})}">
                        <span th:text="|${nominatedReview.userNickname}(ID:${nominatedReview.userLoginId})|">-----</span>
                      </a>
                    </p>
                  </div>
                  <h3 class="review-card-title" th:text="|${nominatedReview.reviewVoteCount}票|">0票</h3> <!-- 右側 -->
                </div>
                <div class="table-border-b-strong flex py-4"> <!-- 書評カードボディ -->
                  <table class="pr-8 mb-auto">
                    <tr>
                      <th>ISBN : </th>
                      <td th:text="${nominatedReview.bookIsbn}">-----</td>
                    </tr>
                    <tr>
                      <th>タイトル : </th>
                      <td th:text="${nominatedReview.bookTitle}">-----</td>
                    </tr>
                    <tr>
                      <th>出版社 : </th>
                      <td th:text="${nominatedReview.bookPublisher}">-----</td>
                    </tr>
                    <tr>
                      <th>著者 : </th>
                      <td th:text="${nominatedReview.bookAuthor}">-----</td>
                    </tr>
                  </table>
                  <div class="flex-1">
                    <p>本文 : </p>
                    <pre th:text="${nominatedReview.reviewContent}"></pre>
                  </div>
                </div>
                <div class="flex justify-between py-4"> <!-- 書評カードフッター -->
                  <div> <!-- 左側 -->
                    <p class="review-card-sub-info" th:text="'投稿日時 : ' + ${#temporals.format(nominatedReview.createdAt, 'yyyy/MM/dd HH:mm')}">0000/00/00 00:00</p>
                    <p class="review-card-sub-info" th:text="'更新日時 : ' + ${#temporals.format(nominatedReview.updatedAt, 'yyyy/MM/dd HH:mm')}">0000/00/00 00:00</p>
                  </div>
                  <a href="review_edit.html" th:href="@{/admin/review/view(id=${nominatedReview.reviewId})}" class="icon-center review-card-sub-info text-decoration-none hover-bold">詳細を確認する<span class="material-symbols-outlined ml-2">keyboard_double_arrow_right</span></a> <!-- 右側 -->
                </div>
              </div>
            </div>
            <div th:if="${#lists.isEmpty(nominatedReviews)}" class="review-card p-8 mt-4">
              <p class="text-center p-8">ノミネートした書評はありません</p>
            </div>
          </div>
        </div>

      </div>
    </main>

    <div id="delete-confirm-modal" class="modal">
      <div>
        <div class="modal-content">
          <h2 class="page-title mx-auto">注意</h2>
          <span class="modal-close"><span class="material-symbols-outlined">close</span></span>

          <div class="mt-8">
            <p>この企画を削除すると、<span class="font-bold underline">関連するすべての書評データも同時に削除されます。</span></p>
            <p><span class="font-bold underline text-danger">削除したデータは復元できません。</span></p>
            <p class="mt-4">削除を実行するには、以下の入力欄に企画URLを入力してください。</p>
          </div>

          <div class="mt-8">
            <p>企画URL : <span th:text="${project.urlKey}">URL-key</span></p>
            <form th:action="@{/admin/project/delete}" method="post">
              <input type="hidden" name="projectId" th:value="${project.id}">
              <input type="text" name="inputUrlKey" class="input-text w-full" th:placeholder="${project.urlKey}" required>
              <div class="btn-wrap mt-8">
                <button type="submit" class="btn btn-danger delete-btn">削除する</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="notification-confirm-modal" class="modal">
      <div>
        <div class="modal-content">
          <h2 class="page-title text-center mx-auto">確認</h2>
          <span class="modal-close"><span class="material-symbols-outlined">close</span></span>

          <div id="confirm-text" class="mt-8">
            <p>以下の内容で【宛先】に通知を送信してよろしいですか？</p>
          </div>

          <div class="mt-8">
            <h3 class="page-title-sub">タイトル</h3>
            <p class="notification-confirm-preview"></p>
          </div>

          <div class="mt-8">
            <h3 class="page-title-sub">内容</h3>
            <pre class="notification-confirm-preview">
              <span class="merge-tag-preview">{user-nickname}</span>さん、こんにちは。
              この度は「<span class="merge-tag-preview">{project-name}</span>」へ書評を投稿いただき、誠にありがとうございました。
              あなたが投稿した「<span class="merge-tag-preview">{review-title}</span>」が一次審査を通過したことをお知らせします。おめでとうございます！

              今後のスケジュールは以下の通りになります。
              これからも象と花プロジェクトと象と花ファンサイトをよろしくお願いいたします。

              <span class="merge-tag-preview">{project-voting_start_at}</span>～<span class="merge-tag-preview">{project-voting_end_at}</span>　二次審査(一般投票)
              2025/08/01　ノミネート作品を一部さわや書店店舗で販売開始
              2025/08/31　大賞発表
            </pre>
          </div>

          <div class="btn-wrap mt-8">
            <button type="button" class="btn" data-modal-close>キャンセル</button>
            <button type="submit" class="btn">送信する</button>
          </div>
        </div>
      </div>
    </div>

    <script src="../../static/js/admin/admin-general.js" th:src="@{/js/admin/admin-general.js}"></script>
    <script src="../../static/js/admin/admin-general.js" th:src="@{/js/admin/project-edit.js}"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // --- 要素の取得 ---
        const phaseRadios = document.querySelectorAll('input[name="targetPhase"]');
        const templateSelect = document.getElementById('template-select');
        const loadButton = document.getElementById('load-template-button');
        const templateTitle = document.getElementById('template-title');
        const templateBody = document.getElementById('template-body');

        // 確認モーダル関連
        const openConfirmBtn = document.getElementById('open-notification-confirm');
        const confirmModal = document.getElementById('notification-confirm-modal');
        const sendButton = confirmModal.querySelector('button[type="submit"]');

        const previewTitle = confirmModal.querySelector('p.notification-confirm-preview');
        const previewPre = confirmModal.querySelector('.notification-confirm-preview');
        const confirmText = confirmModal.querySelector('#confirm-text');

        /**
         * 書評投稿用URLのコピーボタン
         */
        const copyButtons = document.querySelectorAll('.urlKey-copyBtn-fromInput');
        copyButtons.forEach((button, index) => {
          button.addEventListener('click', () => {
            let textToCopy;

            // ボタンの前にある要素からテキストを取得
            const previousElement = button.previousElementSibling;

            if (index === 0) {
              // 1つ目のボタン（企画URL用）
              const urlKeyPreview = document.getElementById('urlKey-preview');
              textToCopy = 'https://zoutohana-fansite.com/project/' + urlKeyPreview.textContent;
            } else {
              // 2つ目のボタン（書評投稿用URL用）
              textToCopy = previousElement.textContent.trim();
            }

            // クリップボードにコピー
            navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                      alert('URLをコピーしました: ' + textToCopy);
                    })
                    .catch(err => {
                      console.error('コピーに失敗しました:', err);
                      alert('コピーに失敗しました');
                    });
          });
        });

        /**
         * 1. テンプレートリストの取得
         */
        const updateTemplateList = async (phase) => {
          try {
            const response = await fetch(`/api/admin/notification/template/list?phase=${phase}`);
            if (!response.ok) throw new Error('リストの取得に失敗しました');
            const templates = await response.json();
            templateSelect.innerHTML = '<option value="">選択してください</option>';
            templates.forEach(template => {
              const option = document.createElement('option');
              option.value = template.id;
              option.textContent = template.title;
              templateSelect.appendChild(option);
            });
          } catch (error) {
            console.error('Error:', error);
          }
        };

        /**
         * 2. 個別テンプレートの呼び出し
         */
        loadButton.addEventListener('click', async () => {
          const selectedId = templateSelect.value;
          if (!selectedId) {
            alert('テンプレートを選択してください');
            return;
          }
          try {
            const response = await fetch(`/api/admin/notification/template/${selectedId}`);
            if (!response.ok) throw new Error('取得失敗');
            const data = await response.json();

            templateTitle.value = data.title;
            templateBody.value = data.content;
          } catch (error) {
            console.error('Error:', error);
            alert('テンプレートの読み込み中にエラーが発生しました');
          }
        });

        /**
         * 3. 確認モーダルの表示
         */
        if (openConfirmBtn) {
          openConfirmBtn.addEventListener('click', () => {
            if (!templateTitle.value.trim() || !templateBody.value.trim()) {
              alert('タイトルと本文を入力してください。');
              return;
            }
            const selectedPhaseRadio = document.querySelector('input[name="targetPhase"]:checked');
            const phaseLabel = selectedPhaseRadio ? selectedPhaseRadio.parentElement.textContent.trim() : "";

        if (previewTitle) previewTitle.textContent = templateTitle.value;
        if (previewPre) previewPre.textContent = templateBody.value;
        if (confirmText) {
        confirmText.innerHTML = `
            <p>以下の内容で<span class="font-bold">${phaseLabel}</span>の書評に通知を送信してよろしいですか？</p>
          `;
            }
            confirmModal.style.display = 'block';
          });
        }

        /**
         * 4. 送信処理 (APIリクエスト & リダイレクト)
         */
        sendButton.addEventListener('click', async (e) => {
          e.preventDefault();

          // 二重送信防止のためにボタンを無効化
          sendButton.disabled = true;

          const params = new URLSearchParams(window.location.search);
          const urlKey = params.get('urlKey');
          const selectedPhase = document.querySelector('input[name="targetPhase"]:checked').value;
          const recipient = (selectedPhase === 'FIRST_PHASE') ? 1 : 2;

          const requestData = {
            recipient: recipient,
            urlKey: urlKey,
            title: templateTitle.value,
            message: templateBody.value
          };

          try {
            const response = await fetch('/api/admin/notification/send', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value
              },
              body: JSON.stringify(requestData)
            });

            if (response.ok) {
              // 成功時の処理
              alert('通知を送信しました。');
              // alertの「OK」が押された後に実行される
              window.location.reload();
            } else {
              const errorData = await response.json();
              alert('送信に失敗しました: ' + (errorData.message || 'サーバーエラー'));
              sendButton.disabled = false; // 失敗時はボタンを元に戻す
            }
          } catch (error) {
            console.error('Error:', error);
            alert('通信エラーが発生しました。');
            sendButton.disabled = false;
          }
        });

        /**
         * 5. モーダルを閉じる
         */
        const closeButtons = confirmModal.querySelectorAll('[data-modal-close], .modal-close');
        closeButtons.forEach(btn => {
          btn.addEventListener('click', () => confirmModal.style.display = 'none');
        });

        window.addEventListener('click', (event) => {
          if (event.target === confirmModal) {
            confirmModal.style.display = 'none';
          }
        });

        phaseRadios.forEach(radio => {
          radio.addEventListener('change', (e) => updateTemplateList(e.target.value));
        });

        const initialPhase = document.querySelector('input[name="targetPhase"]:checked')?.value || 'FIRST_PHASE';
        updateTemplateList(initialPhase);
      });
    </script>
</body>
</html>
