<!-- 【管理者TOP】 -->
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者TOP</title>
    <link rel="icon" th:href="@{/img/zoutohana-jitsubutsu.png}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="../../static/css/admin/admin-style.css" th:href="@{/css/admin/admin-style.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <div th:replace="~{layout-admin :: header}"></div>

    <main id="admin-main">
        <h1 class="page-title flex justify-between">
            <span>
                <span class="material-symbols-outlined scale-bigger text-gray mr-2">file_copy</span>
                開催中の企画
            </span>
            <a href="project_list.html" th:href="@{/admin/project/list}" class="icon-center review-card-sub-info text-decoration-none hover-bold">企画一覧<span class="material-symbols-outlined">double_arrow</span></a>
        </h1>

        <div class="main-content mt-4" th:each="project : ${projects}"> <!-- 企画カードを並べる部分 -->
            <div class="main-content-card p-8 mt-2"> <!-- 企画カード -->
                <div class="table-border-b-strong pb-4"> <!-- 企画カードヘッダー -->
                    <h2 class="review-card-title icon-center">
                        <span th:text="${project.name}">企画名が取得できませんでした</span>
                    </h2>
                    <p class="review-card-sub-info ml-4">
                        <span>
                            https://zoutohana-fansite.jp/project/<span class="text-black" th:text="${project.urlKey}">-----</span>
                        </span>
                        <button
                            type="button"
                            class="btn-sm urlKey-copyBtn"
                            th:data-url="'https://zoutohana-fansite.jp/project/' + ${project.urlKey}">
                            <span class="material-symbols-outlined font-sm">content_copy</span>
                        </button>
                    </p>
                </div>

                <div class="py-4 table-border-b-strong"> <!-- 企画カードボディ -->
                    <ul class="progressbar"> <!-- 進捗部分 -->
                        <li th:classappend="${project.status.getOrder() >= 1} ? 'complete'">書評投稿期間前</li>
                        <li th:classappend="${project.status.getOrder() >= 2} ? 'complete'">書評投稿期間</li>
                        <li th:classappend="${project.status.getOrder() >= 3} ? 'complete'">一次審査</li>
                        <li th:classappend="${project.status.getOrder() >= 4} ? 'complete'">二次審査(投票)</li>
                        <li th:classappend="${project.status.getOrder() >= 5} ? 'complete'">二次審査(確認)</li>
                        <li th:classappend="${project.status.getOrder() >= 6} ? 'complete'">ノミネート発表</li>
                        <li th:classappend="${project.status.getOrder() >= 7} ? 'complete'">大賞発表</li>
                    </ul>
                    <div class="flex"> <!-- 画像・日付等情報(flex) -->
                        <img src="../../static/img/NO-IMAGE.png" th:src="@{/api/image/{url}(url=${project.mainImgUrl})}" class="project-card-thumbnail">
                        <div class="mb-auto pl-4">
                            <h3 class="page-title-sub"th:text="${#temporals.format(project.projectStartAt, 'yyyy/MM/dd HH:mm')} + '～' + ${#temporals.format(project.projectEndAt, 'yyyy/MM/dd HH:mm')}">2025/01/01 12:00～2025/01/01 12:00</h3>
                            <table>
                                <tr>
                                    <th>書評投稿期間 : </th>
                                    <td th:text="${#temporals.format(project.submissionStartAt, 'yyyy/MM/dd HH:mm')} + '～' + ${#temporals.format(project.submissionEndAt, 'yyyy/MM/dd HH:mm')}">2025/01/01 12:00～2025/01/01 12:00</td>
                                </tr>
                                <tr>
                                    <th>書評投票期間 : </th>
                                    <td th:text="${#temporals.format(project.votingStartAt, 'yyyy/MM/dd HH:mm')} + '～' + ${#temporals.format(project.votingEndAt, 'yyyy/MM/dd HH:mm')}">2025/01/01 12:00</td>
                                </tr>
                                <tr>
                                    <th>投稿された書評 : </th>
                                    <td th:text="${project.reviewCount} + '件'">0件</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex justify-between"> <!-- 企画カードフッター -->
                    <div>
                        <button type="button"
                                class="btn"
                                th:data-urlkey="${project.urlKey}"
                                onclick="nextStatus(this)"
                                th:if="${project.published && !project.status.dbValue.equals('AWARD_ANNOUNCEMENT')}">
                            次のステータスに進める
                        </button>
                        <button type="button" class="btn btn-danger" th:data-modal-target="'delete-confirm-modal-' + ${project.id}">削除する</button>
                    </div>
                    <a href="project_edit.html" th:href="@{/admin/project/view(urlKey=${project.urlKey})}" class="icon-center review-card-sub-info text-decoration-none hover-bold">
                        詳細を確認する<span class="material-symbols-outlined">double_arrow</span>
                    </a>
                </div>

                <div th:id="'delete-confirm-modal-' + ${project.id}" class="modal">
                    <div>
                        <div class="modal-content">
                            <h2 class="page-title mx-auto">注意</h2>
                            <span class="modal-close"><span class="material-symbols-outlined">close</span></span>

                            <div class="mt-8">
                                <p>この企画を削除すると、<span class="font-bold underline">関連するすべての書評データも同時に削除されます</span>。</p>
                                <p class="font-bold underline text-danger">削除したデータは復元できません。</p>
                                <p class="mt-4">削除を実行するには、以下の入力欄に企画URLを入力してください。</p>
                            </div>

                            <div class="mt-8">
                                <p>企画URL : <span th:text="${project.urlKey}">URL-key</span></p>
                                <form th:action="@{/admin/project/delete}" method="post">
                                    <input type="hidden" name="projectId" th:value="${project.id}">
                                    <input type="text" name="inputUrlKey" class="input-text w-full" th:placeholder="${project.urlKey}" required>
                                    <div class="btn-wrap mt-8">
                                        <button type="submit" class="btn btn-danger delete-btn">削除する</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
<script src="../../static/js/admin/admin-general.js" th:src="@{/js/admin/admin-general.js}"></script>
    <script>
        function nextStatus(button) {
            const urlKey = button.getAttribute('data-urlkey');

            if (!confirm('この企画のステータスを次に進めてもよろしいですか？')) {
                return;
            }

            // --- CSRFトークンの取得 ---
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            // POSTリクエストを送信
            fetch(`/api/admin/project/status/next/${urlKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // ここでトークンをヘッダーにセット
                    [csrfHeader]: csrfToken
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('ステータスを更新しました');
                        location.reload();
                    } else {
                        // 権限エラーやサーバーエラーのハンドリング
                        response.text().then(text => {
                            alert('エラーが発生しました: ' + (text || 'サーバーエラー'));
                            console.log(text);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('通信に失敗しました。ネットワーク環境を確認してください。');
                });
        }
    </script>
</body>
</html>
